name: Generate Streak Stats

# To include private organization contributions:
# 1. Create a Personal Access Token (PAT) at https://github.com/settings/tokens/new
# 2. IMPORTANT: Select the "repo" scope (or at minimum: "read:org" and "read:user")
#    - "repo" scope gives access to all repositories (public and private)
#    - This is required to see contributions from private organization repositories
# 3. Add it as a repository secret named "GH_PAT"
#    - Go to: Repository → Settings → Secrets and variables → Actions → New repository secret
# 4. IMPORTANT: Check organization settings if contributions are still missing:
#    - Go to each organization → Settings → Third-party access
#    - Ensure "Third-party application access policy" allows your PAT
#    - Some organizations restrict third-party access even with a valid PAT
# 5. The workflow will automatically use it if available, otherwise falls back to GITHUB_TOKEN
#    - GITHUB_TOKEN only has access to public repositories

on:
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main

jobs:
  generate-streak-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate Streak Stats SVG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          import json
          from datetime import datetime, timedelta
          import xml.etree.ElementTree as ET

          username = "Andreas-Garcia"
          theme = "radical"
          # Use PAT if available, otherwise fall back to GITHUB_TOKEN
          token = os.environ.get("GH_PAT") or os.environ.get("GITHUB_TOKEN")
          
          # Query with explicit date range covering multiple years to ensure all contributions are included
          # GitHub's contribution calendar typically shows the past year, but we want all-time data
          from_date = (datetime.now() - timedelta(days=2000)).isoformat() + "Z"  # ~5.5 years
          to_date = (datetime.now() + timedelta(days=1)).isoformat() + "Z"  # Include today
          
          # Query contributions with explicit date range
          query = """
          query($username: String!, $from: DateTime!, $to: DateTime!) {
            user(login: $username) {
              contributionsCollection(from: $from, to: $to) {
                contributionCalendar {
                  totalContributions
                  weeks {
                    contributionDays {
                      date
                      contributionCount
                    }
                  }
                }
              }
            }
          }
          """

          headers = {
              "Authorization": f"Bearer {token}",
              "Content-Type": "application/json"
          }

          variables = {
              "username": username,
              "from": from_date,
              "to": to_date
          }
          
          print(f"Querying contributions from {from_date} to {to_date}")
          response = requests.post(
              "https://api.github.com/graphql",
              json={"query": query, "variables": variables},
              headers=headers
          )

          response.raise_for_status()
          data = response.json()

          if "errors" in data:
              print(f"Warning: GraphQL errors with date range: {data['errors']}")
              print("Trying query without date restrictions...")
              # Fallback: Try without date restrictions
              query_no_dates = """
              query($username: String!) {
                user(login: $username) {
                  contributionsCollection {
                    contributionCalendar {
                      totalContributions
                      weeks {
                        contributionDays {
                          date
                          contributionCount
                        }
                      }
                    }
                  }
                }
              }
              """
              response2 = requests.post(
                  "https://api.github.com/graphql",
                  json={"query": query_no_dates, "variables": {"username": username}},
                  headers=headers
              )
              response2.raise_for_status()
              data = response2.json()
              if "errors" in data:
                  raise Exception(f"GraphQL errors: {data['errors']}")
              print("Successfully queried without date restrictions")

          # Debug: Check which token is being used
          token_type = "PAT (GH_PAT)" if os.environ.get("GH_PAT") else "GITHUB_TOKEN (limited)"
          print(f"Using token type: {token_type}")
          
          # Verify token permissions by checking user info
          try:
              user_check = requests.get(
                  "https://api.github.com/user",
                  headers={"Authorization": f"Bearer {token}"}
              )
              user_check.raise_for_status()
              user_data = user_check.json()
              print(f"Authenticated as: {user_data.get('login', 'unknown')}")
              print(f"Token has repo access: {'repo' in str(user_check.headers.get('X-OAuth-Scopes', ''))}")
          except Exception as e:
              print(f"Warning: Could not verify token permissions: {e}")

          contributions_collection = data["data"]["user"]["contributionsCollection"]
          calendar = contributions_collection["contributionCalendar"]
          weeks = calendar["weeks"]
          # totalContributions from calendar includes all contributions (public + private if token has access)
          total_contributions = calendar["totalContributions"]
          
          # Debug: Print contribution info
          print(f"Total contributions retrieved: {total_contributions}")
          print(f"Number of weeks: {len(weeks)}")
          
          # Count total days with contributions and sum all contributions manually
          total_days_with_contributions = 0
          manual_total = 0
          for week in weeks:
              for day in week["contributionDays"]:
                  count = day["contributionCount"]
                  if count > 0:
                      total_days_with_contributions += 1
                      manual_total += count
          
          print(f"Days with contributions: {total_days_with_contributions}")
          print(f"Manual sum of contributions: {manual_total}")
          print(f"Calendar totalContributions: {total_contributions}")
          
          # Use manual total if it's higher (more accurate)
          if manual_total > total_contributions:
              print(f"Using manual total ({manual_total}) as it's higher than calendar total")
              total_contributions = manual_total

          # Calculate current streak
          today = datetime.now().date()
          current_streak = 0
          longest_streak = 0
          temp_streak = 0

          # Build a dictionary of dates to contribution counts for easier lookup
          contributions_by_date = {}
          all_dates = []
          for week in weeks:
              for day in week["contributionDays"]:
                  date_str = day["date"]
                  # Parse date string (format: "YYYY-MM-DD")
                  try:
                      date_obj = datetime.strptime(date_str, "%Y-%m-%d").date()
                  except:
                      # Fallback: try ISO format
                      date_obj = datetime.fromisoformat(date_str.replace("Z", "")).date()
                  count = day["contributionCount"]
                  contributions_by_date[date_obj] = count
                  all_dates.append(date_obj)

          if not all_dates:
              raise Exception("No contribution data found")

          # Sort dates to ensure chronological order
          all_dates.sort()
          most_recent_date = all_dates[-1]

          # Calculate current streak: count backwards from most recent date
          # A streak continues as long as there are contributions on consecutive days
          check_date = most_recent_date
          while check_date in contributions_by_date:
              if contributions_by_date[check_date] > 0:
                  current_streak += 1
                  check_date = check_date - timedelta(days=1)
              else:
                  break

          # Calculate longest streak: go through all dates chronologically
          temp_streak = 0
          for date_obj in sorted(contributions_by_date.keys()):
              if contributions_by_date[date_obj] > 0:
                  temp_streak += 1
                  longest_streak = max(longest_streak, temp_streak)
              else:
                  temp_streak = 0

          print(f"Most recent contribution date: {most_recent_date}")
          print(f"Current streak: {current_streak} days")
          print(f"Longest streak: {longest_streak} days")

          # Theme colors (radical theme)
          colors = {
              "bg": "#0d1117",
              "border": "#e4e2e2",
              "text": "#e4e2e2",
              "title": "#ff6e96",
              "streak": "#ff6e96",
              "total": "#ff6e96"
          }

          # Generate SVG
          svg_width = 495
          svg_height = 195

          svg = ET.Element("svg", {
              "width": str(svg_width),
              "height": str(svg_height),
              "xmlns": "http://www.w3.org/2000/svg"
          })

          # Background
          bg = ET.SubElement(svg, "rect", {
              "width": str(svg_width),
              "height": str(svg_height),
              "fill": colors["bg"]
          })

          # Title
          title = ET.SubElement(svg, "text", {
              "x": str(svg_width // 2),
              "y": "30",
              "text-anchor": "middle",
              "font-family": "Segoe UI, sans-serif",
              "font-size": "20",
              "font-weight": "bold",
              "fill": colors["title"]
          })
          title.text = "GitHub Streak Stats"

          # Current Streak
          streak_text = ET.SubElement(svg, "text", {
              "x": "50",
              "y": "80",
              "font-family": "Segoe UI, sans-serif",
              "font-size": "14",
              "fill": colors["text"]
          })
          streak_text.text = "Current Streak:"

          streak_value = ET.SubElement(svg, "text", {
              "x": "200",
              "y": "80",
              "font-family": "Segoe UI, sans-serif",
              "font-size": "14",
              "font-weight": "bold",
              "fill": colors["streak"]
          })
          streak_value.text = f"{current_streak} days"

          # Longest Streak
          longest_text = ET.SubElement(svg, "text", {
              "x": "50",
              "y": "110",
              "font-family": "Segoe UI, sans-serif",
              "font-size": "14",
              "fill": colors["text"]
          })
          longest_text.text = "Longest Streak:"

          longest_value = ET.SubElement(svg, "text", {
              "x": "200",
              "y": "110",
              "font-family": "Segoe UI, sans-serif",
              "font-size": "14",
              "font-weight": "bold",
              "fill": colors["streak"]
          })
          longest_value.text = f"{longest_streak} days"

          # Total Contributions
          total_text = ET.SubElement(svg, "text", {
              "x": "50",
              "y": "140",
              "font-family": "Segoe UI, sans-serif",
              "font-size": "14",
              "fill": colors["text"]
          })
          total_text.text = "Total Contributions:"

          total_value = ET.SubElement(svg, "text", {
              "x": "200",
              "y": "140",
              "font-family": "Segoe UI, sans-serif",
              "font-size": "14",
              "font-weight": "bold",
              "fill": colors["total"]
          })
          total_value.text = f"{total_contributions:,}"

          # Save SVG
          tree = ET.ElementTree(svg)
          ET.indent(tree, space="  ")
          tree.write("streak-stats.svg", encoding="utf-8", xml_declaration=True)

          print(f"Generated streak stats: {current_streak} day streak, {longest_streak} longest, {total_contributions} total")
          EOF

      - name: Commit and push SVG
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add streak-stats.svg
          git diff --staged --quiet || git commit -m "Update streak stats [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
